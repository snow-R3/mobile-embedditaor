language: cpp

os:
  - linux
  - osx

dist: trusty

addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - gcc-4.8
    - g++-4.8

install:
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then echo "deb http://download.mono-project.com/repo/debian wheezy main" | sudo tee /etc/apt/sources.list.d/mono-xamarin.list; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sudo apt-get update -qq; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sudo apt-get install -y mono-devel; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then brew install wget xz; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then wget -O mono.pkg http://download.mono-project.com/archive/4.2.1/macos-10-x86/MonoFramework-MDK-4.2.1.102.macos10.xamarin.x86.pkg; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then sudo installer -pkg "mono.pkg" -target /; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ] && [ "$CXX" = "g++" ]; then export CXX="g++-4.8" CC="gcc-4.8"; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then wget -O premake https://dl.dropboxusercontent.com/u/194502/CppSharp/premake5-linux-64; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then wget -O premake https://dl.dropboxusercontent.com/u/194502/CppSharp/premake5-osx; fi
  - chmod +x premake

script: |
  if [ "$TRAVIS_OS_NAME" = "linux" ]; then BUILD_CONF=release_x64; else BUILD_CONF=release_x32; fi &&
  ./premake --file=build/premake5.lua gmake &&
  config=$BUILD_CONF make -C build/gmake/ &&
  TEST_RESULT=0 &&
  for test in build/gmake/lib/Release_*/*.Tests*; do $test || TEST_RESULT=$?; done &&
  exit "$TEST_RESULT"

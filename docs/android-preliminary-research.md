# Android

Currently a work in progress, this document reflects what it will take to get Embeddinator working on Android. The `--gen=Java` and `--platform=Android` options will be used to generate what will be needed to call into C# from a native Android application. `--gen=Java` also depends on the C generator, as it will call into the generated C code.

# Packaging via AAR

The current idea is to package code generated by Embeddinator into an Android `AAR` file. This is the general format for sharing Android libraries for use within Android Studio or other IDEs. It is conceptually similar to a jar file, but has support for Android-specific types of files such as resources and assets.

An `AAR` has the general structure:
- /AndroidManifest.xml
- /classes.jar
- /res/
- /R.txt

Additionally, an AAR file may include one or more of the following optional entries:
- /assets/
- /libs/name.jar
- /jni/abi_name/name.so (where abi_name is one of the Android supported ABIs)
- /proguard.txt
- /lint.jar

Android documentation on this [here](https://developer.android.com/studio/projects/android-library.html).

# Xamarin.Android Requirements

For Xamarin.Android to work for Embeddinator, we will need to satisfy the following:
- Include `libmonosgen-2.0.so` and `libmonodroid.so` as native libraries
- Include .NET assemblies to the final APK uncompressed, this is by default in `/assemblies/` in the root of the APK
- May need changes to Embeddinator to:
    - cross compile with Android NDK
    - instead of compiliing with -L to call into `libmonosgen`, load it dynamically with `dlopen`

# Problems with shipping .NET assemblies in an AAR

## Option 1

The simple approach is to place a .NET assembly into `/assets/assemblies` in the AAR file, which will be present in the final APK when the AAR is used in an Android application. However, Xamarin.Android would need to be modified to load assemblies from `/assets/assemblies` instead of the special root directory used by Xamarin.Android currently at `/assemblies`.

## Option 2

In Android Studio, it is possible to place files in the root of an AAR file via changes to your `build.gradle` file:
```groovy
android {
    ...
    sourceSets {
        main.resources {
            srcDirs = [ 'src/main/root/' ]
        }
    }
}
```
The `sourceSets` option is meant for shipping files like licenses or Java source code in your Android library.

From here, I had a directory named `src/main/root/assemblies` that contained .NET assemblies. I chose the directory name `root`, but any name will do as long as it only contains files you want included. I have not been able to get Android Studio to disable compression on files added in this manner. See Gradle forum post on this [here](https://discuss.gradle.org/t/android-aaptoptions-nocompress/22816).

## Both Options

Embeddinator will mostly likely generate the AAR just by creating a zip archive and making the file extension `*.aar`. Creating an `AAR` manually like this achieves the exact same results for both options.

# Multiple Assemblies

Ideally, a developer may want to use Embeddinator for multiple .NET assemblies in the same Android application. So that means a shared package containing Mono/Xamarin.Android is needed so that duplicate versions of the runtime are not shipped when using muliple Embeddinator-generated AAR files.

When creating a new Android Studio project, dependencies are by default pulled in from JCenter like this:
```groovy
buildscript {
    repositories {
        jcenter()
    }
    dependencies {
        classpath group: 'com.somesharedlibrary',
                  name: 'somesharedlibrary',
                  version: '1.0.0'
    }
}
```
There is also support for any maven repository, local directory, etc.

We could publish a shared Android library for Mono/Xamarin.Android to either:
- Our own custom Maven repository. Blog post on this [here](https://inthecheesefactory.com/blog/how-to-setup-private-maven-repository/en).
- JCenter - should be similar to deploying packages to NuGet. Blog post on this [here](https://medium.com/@daniellevass/how-to-publish-your-android-studio-library-to-jcenter-5384172c4739).

A workaround for now is to run Embeddinator against multiple .NET assemblies as mentoned in [Limitations](https://mono.github.io/Embeddinator-4000/Limitations).

# Current Thoughts on Implementation

`AAR` files generated by Embeddinator could include the following:
- /jni/abi_name/
    - libmonosgen-2.0.so
    - libmonodroid.so
    - lib*.so - compiled C code
- /libs/classes.jar - compiled Java code
- /assets/assemblies/
    - Contains all .NET assemblies
- Other files required by the `AAR` format

Xamarin.Android will need to be modified to load .NET assemblies from `/assets/assemblies`.

In Android Studio, we will instruct developers to modify their Android application's `build.gradle` file, to disable compression on DLL files:
```groovy
android {
    ...
    aaptOptions {
        noCompress 'dll'
    }
}
```

We could also ship a gradle plugin to change this setting. However, I don't think it's a good idea to create a plugin for just this one-liner. If we need a gradle plugin for other things, it would be simple to make the plugin change this setting automatically. An example of this [here](https://stackoverflow.com/a/44221296/132442).